ADVANCED GROUP CI/CD PIPELINE PROJECT

Provision your Jenkins CI server using terraform 

Allow terraform to have an output.tf file that will make the ip address for the provisioned Jenkins CI server to be made available to you 

SSH to Jenkins server and add visudo permission privileges to Jenkins user 

Checker whether Jenkins user exist            sudo cat /etc/passwd  or sudo tail -5 /etc/passwd 

 If not 

Add Jenkins user - sudo useradd jenkins 

Switch to Jenkins user - sudo su jenkins (we will have two users)  vs sudo su - jenkins ( fully switch to jenkins) 

Add jenkins user to docker Group - to see the logs of jenkins in the docker console/ also be able to run docker commands - sudo usermod -a -G docker jenkins or sudo usermod -aG docker jenkins

Run a CI/CD pipeline using Jenkins CI server from git or bitbucket cloning stage to deploying the application to Google Kubernetes cluster (GKC) stage. 

Use very few plugins and if possible, none. 

PLUGINS 

	Docker plugins/dependencies/downloads 

	Kubernetes continuous deploy (Main purpose: store the GKC credentials (config credentials) - this is going to fail all the time. Why? GKC and other clusters do not recognize the updated Kubernetes continuous deploy plugin which is beyond version 1.0
	we are going to upload the Kubernetes continuous deploy manually (Advance and upload) 

	Google kubernetes engine plugin 

	kubectl (the command line interface (CLI) to run kubectl commands on the GKC cluster) 

SPECIAL COMMAND TO RUN BEFORE CREATING THE DECLARATIVE PIPELINE SCRIPT 

Link: https://github.com/joshking1/Commands_Devop_Pipeline.git  

# Update visudo and assign administration privileges to jenkins user

	sudo vi /etc/sudoers 
	jenkins ALL=(ALL) NOPASSWD: ALL 
	sudo useradd jenkins 
	sudo su - jenkins  
	
# Install Docker	sudo apt install docker.io
	docker --version

# Add jenkins user to Docker group
	sudo usermod -aG docker jenkins
	
# Install and Setup Kubectl

	curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
	
	chmod +x ./kubectl 
	
	sudo mv ./kubectl /usr/local/bin
	
# Verify the kubectl installation

	kubectl version
	
STEPS FOR THE JENKINS DECLARATIVE PIPELINE 

Write a declarative Jenkins pipeline script to integrate the necessary tools such as docker, maven etc and include the following stages in your Jenkins build: 

Git Clone (try both scm checkout and git:Git pipeline syntax solutions) 

In the company, you will work with private git repository. 

Include the credentials for the GitHub (username and password)

Maven clean package (integrate Jenkins with maven to enhance the compilation, linkage, packaging, testing, and building of the Java artifact) then (store the Java artifact in the preferred artifactory)

Docker build (build docker image using docker file in your src git repository url ) src is a short form of source code 

Docker tag (create a repo in the docker hub, give your image appropriate name and run the sh command to build the image) Do not forget the DOT in your command 

Docker list (request Jenkins to list the images available in docker) 

Docker login (allow Jenkins’s login to your dockerhub account by creating pipeline syntax and saving the docker hub password as a SECRET TEXT). Do not forget to include the variable for the password. 

Docker push (push the created image to docker hub with the help of Jenkins) 

DEPLOYMENT STAGE 

Provision one of the following clusters: 

        GKC (Google Kubernetes cluster) – the best 
        KOPS (Kubernetes operations) 
        EKS (Elastic Kubernetes Services)  
        KUBEADM (centos or ubuntu server on bare metal or premise) 
        Linode 

Kubernetes deploy with GKC, EKS, KOPS, KUBEADM (deploy the deployment and service manifests with image created by Jenkins to the cluster)

Run the kubectl get deploy to verify the deployment of your manifest 

Run the kubectl get svc to verify the deployment of your load balancer/service manifest

THE ENTIRE DECLARATIVE JENKINS PIPELINE SCRIPT Source:Advanced Group Container Session 

node {

    stage("Git Clone"){
        git credentialsId: 'GIT_HUB_CREDENTIALS', url: 'https://github.com/joshking1/k8s-jenkins-aws.git'
    }
    stage('Maven Clean Build') {
        def mavenHome = tool name: "Maven-3.8.4", type: "maven"
        def mavenCMD = "${mavenHome}/bin/mvn"
        sh "${mavenCMD} clean package"
    }

    }
    stage("Build Docker Image"){
        sh "docker version"
        sh "docker build -t king-httpd ."
    }
    stage("Docker Image list"){

        sh "docker image list"
    }
    stage("Docker Image Tag"){

        sh "docker tag king-httpd josh1991/king-httpd:king-httpd"
    }
    
    stage("Docker Login to Hub Docker"){
     withCredentials([string(credentialsId: 'DOCKER_HUB_PASSWORD', variable: 'PASSWORD')]){
        sh "docker login -u josh1991 -p $PASSWORD"
     }
     
    }
     
    stage("Docker Image Push"){
        
        sh "docker push josh1991/king-httpd:king-httpd"
    }
    stage("Google Kubernetes Cluster deploy"){
        kubernetesDeploy(
            configs: 'springBootMongo.yml',
            kubeconfigId: 'KUBERNETES_CLUSTER_CONFIG',
            enableConfigSubstitution: true 
        )
    }
}

